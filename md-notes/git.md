## git笔记

### 简介

git是一种分布式版本控制系统。与其他传统版本控制系统相比，最大的特点就是分布式，以及分支操作的快速便捷。    

分布式意味着每一个项目的参与者都有一个完整的项目副本，而不是仅仅在每次需要时从集中管理的服务器拉取部分内容进行编辑。好处在于有本地仓库，可以更快且不受网络限制的在自己的本地分支中进行任何开发和更改，且不会因为唯一的服务器宕机而破坏开发进展。  

git不是基于差异记录版本文件的，而是基于快照。即版本各个变化都会产生基于变化的文件的快照，而不是仅仅记录变化细节。正因为如此，git才可以支持创建大量分支，而且可以迅速进行分支之间的的切换，因为创建分支只是在现有共同祖先基础上分叉，不同分支拥有不同的差异文件，所以创建很快，而且每个分支都是现成的完整的文件系统，不需要进行差异计算来切换到另一个分支，直接进行相当于目录切换的操作即可，所以切换成本很低。  

git区分版本节点是基于快照的校验和，git文件存储也是基于元数据方式存储，文件任何更改都会导致校验和变化从而被git检查出，更加能保证文件内容的完整性。

相比于简单易于学习和操作的subversion等版本控制系统，git更注重效率，学习成本也更高，git在基于github托管的开源项目应用很重要，而多数小型公司更倾向于选择subversion，但是这并不是说git只能进行开源项目的开发。只要在服务器上下载git，并把项目目录初始化为git仓库，添加追踪，就可以使用git进行合作开发。  

### 个人服务器仓库操作

#### 服务器端

作为远程仓库，要接受来自其他分支的推送更新，在服务器端就不能有工作目录，否则推送操作会产生冲突错误。所以，在服务器建立一个空的仓库目录，并初始化为裸仓库（不带工作目录）：

`git init --bare`

裸仓库设计中没有工作目录，即不可以在本机直接根据仓库目录树更改仓库内容和提交等操作。一般的仓库有一个隐藏的仓库文件夹.git/，其中包含了本仓库所有数据信息的副本，而服务器创建的裸仓库相当于就是这个文件夹，可以发现其内容结构是一样的。

无论是创建仓库还是克隆仓库，有了仓库后首先应该配置仓库拥有者信息，包括用户名和用户邮件:

`git config user.name "yourname"`配置本仓库用户名信息

`git config user.email "mailname@yourmailbox.com"`配置本仓库用发送邮箱

对于一个人利用git在几台电脑之间同步操作文件的情况，邮件可以填写同一个，用户名最好写不同主机的信息，以方便后期查看日志，区分不同电脑提交的更新。

在服务器端还常用到的操作是查看远程分支提交的更新记录，用git log即可查看。

#### 本地工作分支

创建好服务器端的裸仓库后，在本地克隆分支，再将需要跟踪同步的文件放入仓库，同步到服务器即可。具体操作为首先克隆服务器仓库：

`git clone username@ip:path/repository`克隆裸仓库

`git config user.name "yourname"`配置本仓库用户名信息

`git config user.email "mailname@yourmailbox.com"`配置本仓库用发送邮箱

`cp files ./`将需要跟踪的文件加入工作目录

`git add *`将工作目录的文件加入暂存区

`git commit -m "提交的备注"`提交更新到本地仓库

`git push [origin repository url]`将本地仓库更新同步推送到服务器，[]部分省略则默认为克隆时用的远程仓库

除了将本机器的更改推送到服务器之外，还有经常做的操作就是将服务器的变化合并到本地，尤其在多个主机都可能推送更改给服务器时。所以，一般在开始编辑本地仓库之前，都要先取回服务器分支的更新并合并到本地，然后才开始编辑修改。

`git fetch `不接目标仓库默认取回服务器仓库的更新

`git merge `不接目标仓库默认合并服务器取回的分支到本地分支

### 基础操作

#### 服务器上初始化目录为git仓库

进入项目目录，运行git命令：

##### `git init`

创建一个空的git仓库，然后运行git命令：

##### `git add *`

将项目文件都加入暂存区（或者只添加想要通过git管理的部分），以备进一步提交到本地服务器仓库。

运行git命令：

##### `git commit `

将所有暂存区文件提交到本地服务器仓库，每次提交操作都会产生一个快照，相当于一个小的版本变化，必须注明快照变化，即通过-m和后面的注释进行快照说明。

对于团队开发且服务器只用于存储公共仓库而不再服务器上直接开发的，服务器上的仓库应该设置为裸仓库，以免合作者推送到服务器上时因为服务器分支存在工作目录而拒绝推送。或者可以在服务器上建立一个分支并切换到新建分支，这样合作者就可以推送到原来的分支了。

#### 本地克隆服务器上的分支

在本地可以安装git bash，进入想要克隆到的目录，执行

`git clone [user]@server:/path/to/repository`

现在本地仓库已经克隆完成，在本地进行项目开发，在一定时机推送开发的内容回服务器即可。首先，对需要更改的内容进行更改，然后执行

`git status`

查看工作区编辑的变化，决定哪些变化要提交。运行

`git add filename`

将列出的需要提交的变化的文件添加到暂存区，运行

`git commit -m "some version explain"`

将暂存区文件提交到本地仓库，并产生一次快照。运行

`git push `

将本地分支的变化推送到服务器，完成。



#### 配置信息

运行命令

`git config -l`

可以查看当前配置信息以及可以配置的项，对于需要修改的配置项，运行命令

`git config [--global] 配置项名称 配置项值`

即可重新给该配置项赋值。其中[--global]可选，若不写则配置针对本仓库，写了则针对本系统上所以git仓库。

#### 常用操作

可以把git管理内容分为四个区：工作区、暂存区、本地仓库、远程仓库。

工作区即`.git`仓库所在目录，可以看到其文件树；暂存区和本地仓库的内容都存储在`.git`文件夹中；远程仓库即可以推送和拉去消息的源仓库，即config中`remote.origin.url`指向的仓库。

其中每个区内都有其结构树。在最初完成从远程仓库克隆项目后，四个区的结构树相同。平时增删改文件在工作区进行，当进行了一定编辑操作后，工作区和暂存区的结构树不同，运行

##### `git status`

会看到有待加入缓存区的文件以备提交到本地仓库，运行

##### `git add *`

可以把工作区的文件同步到暂存区，然后运行

##### `git commit`

可以把暂存区的文件同步到本地仓库形成一个快照，运行

##### `git push`

可以把本地仓库的文件推送到远程仓库，运行

##### `git diff`

可以查看工作区与暂存区的区别细节（不仅仅是有差异的文件名）

运行

##### `git rm`

可以把工作区的文件彻底删除，若仅仅用linux的rm命令，则运行一次后会取消git对该文件的track，再次运行才会彻底删除该文件。

运行

##### `git mv `

命令可以移动或修改文件名，若直接用linux的mv操作，则会删除原文件再创建变化后的文件，在后续提交变化时更多麻烦，所以rm和mv命令都最好加上git。

git 保存了各个版本的快照，所以很方便进行版本的回退。运行

##### `git reset `

命令即回退命令，N为倒退版本数。若需要回退的版本与现在HEAD版本相差太远，可以用其版本的哈希值前几个数（只要是独一无二的，且至少4位都行）代替HEAD~N。reset 默认将本地版本库和暂存区退回到指定版本的状态，而工作区的状态不变，即reset后运行`git status`会看到有工作区带加入暂存区文件。此时相当与暂存区与版本库都处于回退的版本，工作区处于回退操作前的版本，且版本库的日志也变回了指定版本刚提交时的状态。若此时将工作区文件同步到暂存区和本地仓库，则相当于回退操作被撤销，但是版本日志变化了。若在回退的版本号前加上`--hard`则包括工作区在内的三个区都回退到指定版本状态，回退前的状态将不可恢复，除非远程仓库保存有会退前的版本快照。只是回退暂存区工作区到暂存区的add，按照`git status`的提示操作即可。

查看本地仓库的版本日志可以知道提交快照时间，版本号，作者等信息，运行

##### `git log`

即可，如果仓库日志较多，可以在命令后加上限定--oneline，使每条日志只展示在一行，更多限定方法可以用git log --help查看。

与远程仓库通信通过

##### `git remote -v`

可以查看远程仓库信息，用

##### `git fetch`

可以取回远程仓库的分支快照，用

##### `git merge`

可以合并所在分支与目标分支

##### `git push`

可以推送本地版本到对应的远程仓库，如果两个分支对同一个文件做了修改，则合并分支类的命令`git merge`,`git push`,以及`git pull`都会失败，并且提示冲突信息，而且切换到（branch|MERGING）分支状态，此时可以手动修改冲突文件，保留需要的版本内容后再次git add *，commit。无论此时有没有更改冲突文件，此次add操作就等于告诉git，将冲突文件以现在的状态保留进行合并。所以实际上即便没有区修改冲突文件，只要add后提交，都会合并并保留本分支下有冲突的文件版本。注意切换分支，合并分支等操作前，先把本分支的修改提交快照。

分支可以用

##### `git branch`

命令查看，后接分支名可以创建分支。用

##### `git checkout branchname`

可以切换到指定分支，用

##### `git branch -d branchname`

可以删除分支，比如已经合并了变化的分支。

对于比较重要的快照，可以打上标签以方便以后检索，用

##### `git tag -a tagname commitnumber`

给指定快照打上标签，以后可以用

##### `git tag`

查看所有标签，用

##### `git show tagname`

查看指定标签的信息，比如其对应的commit校验和，用来检出指定版本的快照

